# HAgent Integration Tests

This directory contains integration tests for HAgent that test against Docker images (cva6:2026.01 and simplechisel:2026.01).

## Overview

The integration tests validate HAgent tools and workflows using real HDL projects extracted from Docker images. Tests use `setup_mcp.sh` to extract project files locally, enabling code modification for bug injection and validation testing.

## Test Suite

### Test 1: Synth + LEC with Bug Injection
**File:** `test_synth_lec_bug_injection.py`

Tests the complete synthesis and logic equivalence checking workflow:
1. Synthesize reference design (tag: "reference")
2. Inject bug in extracted source code
3. Synthesize buggy version (tag: "bug1") → LEC should FAIL
4. Undo bug
5. Synthesize fixed version (tag: "nobug") → LEC should PASS

**Modules tested:**
- CVA6 ALU (`core/alu.sv`)
- SimpleChisel GCD (`gcd/GCD.sv`)

### Test 2: Locate VCD Command
**File:** `test_locate_vcd.py`

Tests the locator CLI for mapping variables between HDL representations:
- VCD → Verilog signal mapping
- Validates source location mappings

**Note:** Skips if no VCD files found in Docker images.

### Test 3: Synth + STA Validation
**File:** `test_synth_sta_validation.py`

Tests that Static Timing Analysis reports reasonable values:
- Runs synthesis with STA enabled (`--run-sta`)
- Parses `sta.log` for timing metrics
- Validates values are within expected ranges (not zero, not absurd)

### Test 4: Docker Tool Validation
**File:** `test_docker_tools.py`

Tests that required tools are installed and working in Docker images:
- Uses `docker_args.sh` to generate Docker run command
- Runs tool version checks (yosys, slang, sta, verilator, etc.)
- Validates tool versions and availability

## Prerequisites

### Docker Images
Tests require Docker images to be available:
- `mascucsc/hagent-cva6:2026.01`
- `mascucsc/hagent-simplechisel:2026.01`

Pull images:
```bash
docker pull mascucsc/hagent-cva6:2026.01
docker pull mascucsc/hagent-simplechisel:2026.01
```

### Tools
- Docker
- Python 3.8+
- uv (Python package manager)
- PyYAML (installed via uv)

## Running Tests

### Run all integration tests
```bash
pytest tests/integration/ -m integration -v
```

### Run specific test
```bash
pytest tests/integration/test_synth_lec_bug_injection.py -v
pytest tests/integration/test_locate_vcd.py -v
pytest tests/integration/test_synth_sta_validation.py -v
pytest tests/integration/test_docker_tools.py -v
```

### Run tests for specific Docker image
```bash
pytest tests/integration/ -m cva6 -v
pytest tests/integration/ -m simplechisel -v
```

### Run slow tests only
```bash
pytest tests/integration/ -m "integration and slow" -v
```

### Skip integration tests in normal runs
```bash
pytest -m "not integration"
```

## Environment Variables

Tests use environment variables from `hagent_server.sh` (generated by `setup_mcp.sh`):
- `HAGENT_DOCKER`: Docker image name
- `HAGENT_REPO_DIR`: Repository directory path
- `HAGENT_BUILD_DIR`: Build output directory path
- `HAGENT_CACHE_DIR`: Cache directory path
- `HAGENT_OUTPUT_DIR`: Output directory path

These are automatically set by the test fixtures.

## Directory Structure

```
tests/integration/
├── __init__.py
├── conftest.py                        # Shared fixtures
├── README.md                          # This file
│
├── test_synth_lec_bug_injection.py    # Test 1
├── test_locate_vcd.py                 # Test 2
├── test_synth_sta_validation.py       # Test 3
├── test_docker_tools.py               # Test 4
│
├── utils/                             # Test utilities
│   ├── setup_helper.py                # Wrapper for setup_mcp.sh
│   ├── bug_injector.py                # Code modification helpers
│   ├── sta_parser.py                  # Parse sta.log files
│   └── docker_helper.py               # Wrapper for docker_args.sh
│
└── data/                              # Test data
    ├── expected/                      # Expected value ranges
    │   ├── cva6_sta_ranges.yaml
    │   └── simplechisel_sta_ranges.yaml
    └── tool_requirements/             # Required tools per image
        ├── cva6_tools.yaml
        └── simplechisel_tools.yaml
```

## Adding New Tests

### 1. Create test file
```python
import pytest

@pytest.mark.integration
@pytest.mark.cva6  # or @pytest.mark.simplechisel
def test_my_integration(cva6_setup, test_config):
    repo_dir = cva6_setup["repo_dir"]
    build_dir = cva6_setup["build_dir"]
    env = cva6_setup["env_vars"]

    # Your test code here
    ...
```

### 2. Use existing fixtures
- `cva6_setup`: Extracts CVA6, returns paths and env vars
- `simplechisel_setup`: Extracts SimpleChisel, returns paths and env vars
- `test_config`: Configuration dict with timeouts and ranges

### 3. Run CLI tools via subprocess
```python
import subprocess

result = subprocess.run(
    ["uv", "run", "python", "scripts/synth.py", ...],
    env=env,
    capture_output=True,
    text=True,
    timeout=300
)

assert result.returncode == 0, f"Command failed: {result.stderr}"
```

## Troubleshooting

### Test artifacts taking up space
```
Tests are creating many files in output/integration_tests/
```
**Solution:** Clean up test artifacts:
```bash
rm -rf output/integration_tests/
```

Note: Integration tests store artifacts in `output/integration_tests/` instead of `/tmp` to avoid disk space issues and make debugging easier.

### Docker images not found
```
Error: Failed to extract template from Docker image
```
**Solution:** Pull the Docker image: `docker pull mascucsc/hagent-cva6:2026.01`

### setup_mcp.sh fails
```
RuntimeError: setup_mcp.sh failed
```
**Solution:** Check that Docker is running and images are available.

### Cache corruption
```
RuntimeError: setup_mcp.sh extracted directories but they are empty
```
**Solution:** Clear the cache:
```bash
rm -rf .cache/setup_*_mcp_*
```

### Tool not found in Docker
```
AssertionError: yosys not found or failed
```
**Solution:** Update tool requirements in `data/tool_requirements/` or verify Docker image contains the tool.

### STA validation warnings
```
STA validation warning: Slack X outside expected range
```
**Solution:** This is a warning, not a failure. Update expected ranges in `data/expected/cva6_sta_ranges.yaml` based on actual values.

### VCD files not found
```
pytest.skip: No VCD files found for testing
```
**Solution:** This is expected - VCD files may not exist in Docker images. Test is skipped automatically.

## Test Timeouts

Default timeouts (configurable in `conftest.py`):
- Synthesis: 300s (5 minutes)
- LEC: 600s (10 minutes)
- Docker commands: 30s
- General: 600s (10 minutes)

## Notes

- Tests run in isolated directories under `output/integration_tests/` (not /tmp)
- Each test creates a subdirectory named after the test function
- Test artifacts are preserved for debugging (not automatically cleaned up)
- Original source files are restored after bug injection tests (in `finally` block)
- Docker extraction is cached by `setup_mcp.sh` in `.cache/setup_*_mcp_*`

## Test Artifacts

Test artifacts are stored in organized directories:
```
output/integration_tests/
├── cva6/
│   ├── test_cva6_alu_bug_detection/
│   │   ├── repo/          # Extracted CVA6 source
│   │   ├── build/         # Synthesis outputs
│   │   ├── cache/         # Build cache
│   │   └── logs/          # Execution logs
│   ├── test_cva6_sta_reports/
│   └── ...
└── simplechisel/
    ├── test_simplechisel_gcd_bug_detection/
    └── ...
```

To clean up test artifacts:
```bash
rm -rf output/integration_tests/
```

## Future Enhancements

Potential additions:
- More HDL projects (XiangShan, SoomRV)
- Additional tool chains (formal verification, simulation)
- Performance benchmarking
- CI integration with GitHub Actions
