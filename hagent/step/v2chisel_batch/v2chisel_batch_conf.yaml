v2chisel_batch:
  # Retry configuration
  retry_config:
    max_compile_retries: 3  # Max attempts for compilation errors
    max_lec_retries: 3      # Max attempts for LEC failures

  llm:
    # model: "bedrock/us.meta.llama3-3-70b-instruct-v1:0"
    # model: "openai/o3-mini-2025-01-31"
    # model: "openai/gpt-4o"
    model: "openai/gpt-5-codex"  # Uses Responses API (v1/responses)
    aws_region_name: "us-east-1"
    # max_tokens: removed - let llm_wrap.py choose optimal defaults per model
    # Reasoning models (gpt-5-codex, o3-mini) need 32k-64k tokens to complete responses
    temperature: 0  # Restored to 1 - applier now handles whitespace variations
  
  # Initial prompt for first iteration
  prompt_initial:
    - role: system
      content: |
        You are an expert AI assistant specialized in translating Verilog changes to corresponding Chisel code modifications.
        Your goal is to generate precise Chisel diffs that, when applied, will produce Verilog logically equivalent to the target changes.

        CRITICAL: You must respond with ONLY the unified diff. No explanations, no alternatives, no commentary.
        Your entire response must be a single, clean unified diff that starts with "---" and contains only the necessary changes.
    
    - role: user
      content: |
        I have a Chisel hardware design that generates Verilog. I need to modify the Chisel code to match specific changes made to the Verilog.
        
        Here is the unified diff showing the desired Verilog changes:
        ```
        {verilog_diff}
        ```
        
        Here are hints from the corresponding Chisel code that likely need modification:
        ```
        {chisel_hints}
        ```
        
        Please generate a unified diff for the Chisel code that will produce the desired Verilog changes.

        CRITICAL REQUIREMENTS - FOLLOW EXACTLY:
        - Output ONLY the unified diff in standard format
        - Use minimal hunks containing only the necessary changes
        - Do NOT include any explanation, commentary, notes, or reasoning
        - Do NOT include multiple diff attempts or alternative solutions
        - Do NOT include phrases like "should be", "to", "Here is the answer"
        - Ensure the diff can be applied to existing Chisel source files
        - Your response must start with "---" and end with a complete unified diff

        CRITICAL - REMOVAL LINES MUST BE EXACT COPIES FROM HINTS:
        - For lines to REMOVE (marked with '-' in your diff): You MUST copy them EXACTLY from the hints above
        - Do NOT recreate, rephrase, or reformat removal lines - copy them character-for-character
        - Copy the EXACT indentation (spaces/tabs), spacing around operators, and comments from the hints
        - Only ADDITION lines (marked with '+') should be your newly generated code
        - Think: CUT exact lines from hints → PASTE as removal lines → ADD your new code
        - If a line needs modification, show the EXACT original as removal, then your modified version as addition

        Generate ONLY the Chisel unified diff now:

  # Prompt for retry when compilation fails
  prompt_compile_error:
    - role: system
      content: |
        You are an AI specialized in fixing Chisel compilation errors while maintaining the intended functionality.
    
    - role: user
      content: |
        The previous Chisel diff caused compilation errors. I need a corrected version.
        
        Original Verilog diff target:
        ```
        {verilog_diff}
        ```
        
        Previous Chisel diff that failed:
        ```
        {previous_chisel_diff}
        ```
        
        Compilation error:
        ```
        {compile_error}
        ```
        
        Updated hints from Chisel code:
        ```
        {chisel_hints}
        ```
        
        Please generate a corrected unified diff that:
        - Fixes the compilation error
        - Still achieves the target Verilog changes
        - Uses proper Chisel syntax

        CRITICAL - REMOVAL LINES MUST BE EXACT COPIES FROM HINTS:
        - For lines to REMOVE (marked with '-'): Copy them EXACTLY from the hints above
        - Do NOT recreate or reformat removal lines - copy character-for-character
        - Copy EXACT indentation, spacing, and comments from hints
        - Only ADDITION lines ('+') should be your new code

        Output ONLY the corrected unified diff:

  # Prompt for retry when LEC fails
  prompt_lec_error:
    - role: system
      content: |
        You are an AI expert at ensuring Chisel-generated Verilog passes Logic Equivalence Check (LEC) against target specifications.
    
    - role: user
      content: |
        The Chisel code compiled successfully but failed Logic Equivalence Check (LEC). I need corrections.
        
        Target Verilog diff:
        ```
        {verilog_diff}
        ```
        
        Current Chisel diff:
        ```
        {current_chisel_diff}
        ```
        
        LEC failure details:
        ```
        {lec_error}
        ```
        
        Hints from Chisel code for potential fixes:
        ```
        {chisel_hints}
        ```
        
        Please generate a refined unified diff that will pass LEC by ensuring logical equivalence with the target Verilog.

        CRITICAL - REMOVAL LINES MUST BE EXACT COPIES FROM HINTS:
        - For lines to REMOVE (marked with '-'): Copy them EXACTLY from the hints above
        - Do NOT recreate or reformat removal lines - copy character-for-character
        - Copy EXACT indentation, spacing, and comments from hints
        - Only ADDITION lines ('+') should be your new code

        Output ONLY the refined unified diff:

  # Prompt for final attempt with broader context
  prompt_final_attempt:
    - role: system
      content: |
        You are an AI making a final attempt to generate working Chisel code. Use all available information and consider alternative approaches.
    
    - role: user
      content: |
        Previous attempts have failed. This is the final attempt to generate correct Chisel code.
        
        Target Verilog changes:
        ```
        {verilog_diff}
        ```
        
        All previous attempts and their errors:
        ```
        {attempt_history}
        ```
        
        Complete Chisel hints with broader context:
        ```
        {chisel_hints}
        ```
        
        Please make a final attempt with a potentially different approach. Consider:
        - Alternative Chisel constructs that achieve the same Verilog
        - Broader context changes if needed
        - Different interpretation of the Verilog requirements

        CRITICAL - REMOVAL LINES MUST BE EXACT COPIES FROM HINTS:
        - For lines to REMOVE (marked with '-'): Copy them EXACTLY from the hints above
        - Do NOT recreate or reformat removal lines - copy character-for-character
        - Copy EXACT indentation, spacing, and comments from hints
        - Only ADDITION lines ('+') should be your new code

        Output ONLY the unified diff for this final attempt:

  # Prompt when removal lines are ambiguous (multiple identical lines in hints)
  prompt_ambiguous_removal:
    - role: system
      content: |
        Your previous diff had ambiguous removal lines - multiple identical lines exist in the hints.
        You must include MORE CONTEXT (surrounding lines) to make the removal location unique and specific.

    - role: user
      content: |
        Your previous diff could not be applied because some removal lines are AMBIGUOUS.

        The following removal lines appear MULTIPLE TIMES in the code:
        ```
        {ambiguous_lines_info}
        ```

        PROBLEM: When a line appears multiple times, we don't know WHICH occurrence you want to remove.

        SOLUTION: Include 2-3 CONTEXT LINES before and after the lines you want to remove.
        This makes the location unique and unambiguous.

        Original Verilog diff target:
        ```
        {verilog_diff}
        ```

        Chisel hints (note: some lines appear multiple times):
        ```
        {chisel_hints}
        ```

        CRITICAL REQUIREMENTS:
        - Include at least 2-3 context lines BEFORE the lines you want to remove
        - Include at least 2-3 context lines AFTER the lines you want to remove
        - This creates a unique "fingerprint" that identifies the exact location
        - Copy the EXACT removal lines from hints (character-for-character)

        Output ONLY the corrected unified diff with MORE CONTEXT: